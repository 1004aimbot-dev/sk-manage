generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==============================
// 1. 사용자 및 인증 (Admin)
// ==============================
model User {
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  image     String?
  role      String   @default("staff") // admin, pastor, staff, teacher

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================
// 2. 교인 관리 (Member)
// ==============================
model Member {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  birthDate DateTime?
  gender    String?  // 남/여
  address   String?  // 주소

  // 직분 (목사, 장로, 권사, 집사, 성도, 청년, 학생, 어린이)
  role      String   @default("성도")
  
  // 교구/구역 정보 (선택)
  district  String?  

  // 소속 부서 연결 (다대다 가능하지만 단순화를 위해 메인 부서 1개 또는 별도 매핑)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  attendances Attendance[]
  reservations Reservation[]
  
  // 찬양대 파트 (이름만 있으면 됨)
  choirPart String? // Soprano, Alto, Tenor, Bass

  // 가족 정보
  spouseName String?
  children   String? // JSON string: [{name: "...", age: ...}, ...]

  registeredAt DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==============================
// 3. 조직/부서 (Department - 트리 구조)
// ==============================
model Department {
  id          String   @id @default(cuid())
  name        String   // 예: 유치부, 재정위원회, 찬양대
  description String?
  
  parentId    String?
  parent      Department? @relation("DeptHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DeptHierarchy")

  members     Member[]
  posts       Post[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==============================
// 4. 예배/설교 (Worship)
// ==============================
model Sermon {
  id          String   @id @default(cuid())
  title       String
  preacher    String   // 설교자
  date        DateTime // 설교 날짜
  videoUrl    String?  // 유튜브 링크
  thumbnailUrl String?
  content     String?  // 본문/요약
  
  series      String?  // 설교 시리즈

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==============================
// 5. 비전센터/시설 예약 (Reservation)
// ==============================
model Facility {
  id          String   @id @default(cuid())
  name        String   // 대예배실, 비전홀, 식당, 카페
  location    String?  // 본관 2층, 비전센터 1층
  capacity    Int?     // 수용인원
  description String?

  reservations Reservation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reservation {
  id          String   @id @default(cuid())
  
  facilityId  String
  facility    Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  memberId    String?  // 예약자 (교인)
  member      Member?  @relation(fields: [memberId], references: [id], onDelete: SetNull)

  startTime   DateTime
  endTime     DateTime
  purpose     String   // 사용 목적
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([facilityId, startTime])
}

// ==============================
// 6. 출석 관리 (Attendance)
// ==============================
model Attendance {
  id        String   @id @default(cuid())
  date      DateTime // 기준 날짜 (보통 주일)
  
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  status    String   // 출석, 결석, 사유 인정
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, memberId]) // 같은 날 중복 출석 방지
}

// ==============================
// 6. 게시판/커뮤니티 (Community)
// ==============================
model Post {
  id          String   @id @default(cuid())
  title       String
  content     String?
  category    String   // NOTICE(공지), ALBUM(앨범), NEWS(교우소식), RESOURCE(자료실)
  
  viewCount   Int      @default(0)
  
  // 첨부파일 (이미지/문서 - 메타데이터)
  files       File[]

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model File {
  id        String   @id @default(cuid())
  url       String   // 로컬 경로 or S3 URL
  name      String
  mimeType  String
  size      Int
  
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ==============================
// NextAuth (SQLite 호환)
// ==============================
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
